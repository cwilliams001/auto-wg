#!/bin/bash
# System information script
# Generated by Auto-WG Ansible

echo "=================================="
echo "    AUTO-WG SERVER STATUS"
echo "=================================="
echo ""

# System information
echo "üñ•Ô∏è  SYSTEM INFO:"
echo "   Hostname: $(hostname)"
echo "   OS: $(lsb_release -d | cut -f2)"
echo "   Kernel: $(uname -r)"
echo "   Uptime: $(uptime -p)"
echo "   Load: $(uptime | awk '{print $NF}')"
echo ""

# Resource usage
echo "üíæ RESOURCE USAGE:"
echo "   Memory: $(free -h | awk 'NR==2{printf "%s/%s (%.0f%%)", $3,$2,$3*100/$2}')"
echo "   Disk: $(df -h / | awk 'NR==2{printf "%s/%s (%s)", $3,$2,$5}')"
echo "   CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)% usage"
echo ""

# Network information
echo "üåê NETWORK:"
echo "   Public IP: $(curl -s ifconfig.me 2>/dev/null || echo "Unable to fetch")"
echo "   Local IP: $(hostname -I | awk '{print $1}')"
echo ""

# WireGuard status
echo "üîê WIREGUARD STATUS:"
if systemctl is-active --quiet wg-quick@wg0; then
    echo "   WG Interface: ‚úÖ Active"
    echo "   Connected Clients: $(wg show | grep -c peer)"
else
    echo "   WG Interface: ‚ùå Inactive"
fi

if systemctl is-active --quiet wg_service; then
    echo "   WG Service: ‚úÖ Running on port {{ wg_service_port }}"
else
    echo "   WG Service: ‚ùå Not running"
fi
echo ""

# Security status
echo "üõ°Ô∏è  SECURITY STATUS:"
if systemctl is-active --quiet fail2ban; then
    echo "   Fail2ban: ‚úÖ Active"
    BANNED_COUNT=$(fail2ban-client status sshd 2>/dev/null | grep "Currently banned" | awk '{print $NF}' || echo "0")
    echo "   Banned IPs: $BANNED_COUNT"
else
    echo "   Fail2ban: ‚ùå Inactive"
fi

if ufw status | grep -q "Status: active"; then
    echo "   Firewall: ‚úÖ Active"
else
    echo "   Firewall: ‚ùå Inactive"
fi

echo "   SSH Port: $(grep "^Port" /etc/ssh/sshd_config | awk '{print $2}' || echo "22")"
echo ""

# Service status
echo "üîß SERVICES:"
for service in ssh caddy wg_service fail2ban ufw; do
    if systemctl is-active --quiet $service 2>/dev/null; then
        echo "   $service: ‚úÖ Running"
    else
        echo "   $service: ‚ùå Stopped"
    fi
done
echo ""

# Recent activity
echo "üìä RECENT ACTIVITY:"
echo "   Last 5 logins:"
last -n 5 | head -5 | while read line; do
    echo "     $line"
done
echo ""

# Disk usage breakdown
echo "üíΩ DISK USAGE:"
df -h | grep -v tmpfs | grep -v udev | tail -n +2 | while read line; do
    echo "   $line"
done
echo ""

# Auto-WG specific info
echo "üöÄ AUTO-WG INFO:"
echo "   API Base URL: https://{{ domain_name }}"
echo "   Health Check: https://{{ domain_name }}/health"
echo "   Generate Config: POST https://{{ domain_name }}/generate_config"
echo "   List Clients: GET https://{{ domain_name }}/list_clients"
echo "   Log Directory: {{ wg_service_dir }}"
echo ""

echo "=================================="
echo "Generated: $(date)"
echo "=================================="